
R version 4.0.3 (2020-10-10) -- "Bunny-Wunnies Freak Out"
Copyright (C) 2020 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

[Previously saved workspace restored]

> 
> # teste de download NMME
> pcks <- c("terra", "tidync", "tidyverse", "fs", "tictoc", "data.table")
> easypackages::libraries(pcks)
Loading required package: terra
terra version 0.9.11
Loading required package: tidync
Loading required package: tidyverse
── Attaching packages ─────────────────────────────────────── tidyverse 1.3.0 ──
✔ ggplot2 3.3.2     ✔ purrr   0.3.4
✔ tibble  3.0.4     ✔ dplyr   1.0.2
✔ tidyr   1.1.2     ✔ stringr 1.4.0
✔ readr   1.4.0     ✔ forcats 0.5.0
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::collapse()  masks terra::collapse()
✖ readr::cols()      masks terra::cols()
✖ dplyr::desc()      masks terra::desc()
✖ tidyr::expand()    masks terra::expand()
✖ tidyr::extract()   masks terra::extract()
✖ tidyr::fill()      masks terra::fill()
✖ dplyr::filter()    masks stats::filter()
✖ dplyr::lag()       masks stats::lag()
✖ tidyr::pack()      masks terra::pack()
✖ dplyr::select()    masks terra::select()
✖ tidyr::separate()  masks terra::separate()
✖ purrr::transpose() masks terra::transpose()
Loading required package: fs
Loading required package: tictoc
Loading required package: data.table

Attaching package: ‘data.table’

The following objects are masked from ‘package:dplyr’:

    between, first, last

The following object is masked from ‘package:purrr’:

    transpose

The following objects are masked from ‘package:terra’:

    shift, transpose

All packages loaded successfully
> 
> 
> 
> #' Baixa o arquivo anual da previsao retrospectiva do NMME para a AS
> #' Download da previsao retrospectiva do Sistema NMME recortado para 
> #' a America do Sul, incluindo os 12 tempos de antecedencia e os 10
> #' tempos de inicio da precisao.  
> #'
> #' @param ano 
> #' @param modelo 
> #' @param variavel 
> #'
> #' @return
> #' @export
> #'
> #' @examples
> down_nmme <- function(ano = 1981, modelo = "CanSIPSv2", variavel = "tmax"){
+   # ano <- as.character(1981);  modelo <- "CanCM4i";variavel <- "prec"
+   
+   ano <- as.character(ano)
+   
+   data_link <- paste0(
+     "http://iridl.ldeo.columbia.edu/SOURCES/.Models/.NMME/",
+     # modelo
+     ".modelo/.HINDCAST/.MONTHLY/",
+     # variavel
+     ".variavel/",
+     # Forecast Start Time (forecast_reference_time)
+     "S/%280000%201%20Jan%20YYYY%29%280000%2030%20Dec%20YYYY",
+     # sub dominio
+     "%29RANGEEDGES/X/%2830W%29%2885W%29RANGEEDGES/Y/%2860S%29%2815N%29RANGEEDGES/",
+     # nome dop arq default
+     "data.nc"
+   )
+   
+   prefix <- paste0("nmme_", variavel, "_", modelo, "_", ano) 
+   dest_file <- path("/home/andreza/Desktop/test-down-NMME/output", 
+                     str_replace(path_file(data_link), "data", prefix)
+   )
+   
+   Sys.sleep(1)
+   
+   data_link_ano <- str_replace_all(data_link, "variavel", variavel)
+   data_link_ano <- str_replace_all(data_link_ano, "modelo", modelo)
+   data_link_ano <- str_replace_all(data_link_ano, "YYYY", ano)
+   
+   #path_file(data_link_ano)
+   message("Baixando arquivo: ", dest_file)
+   
+   download.file(data_link_ano, destfile = dest_file, mode = "wb")
+   
+   if(file.exists(dest_file)){
+     return(dest_file)
+   }
+   
+   return(paste0("Nao foi possivel baixar o arquivo: ", dest_file))  
+ }
> 
> tic()
> 
> start_y <- 1981
> end_y <- 2018
> 
> # modelos <- c("CanCM4i",
>              # "CanSIPSv2",
>              # "CMC1-CanCM3",
>              # "CMC2-CanCM4",
>              # "GEM-NEMO",
>              # "NASA-GEOSS2S",
>              # "NCAR-CESM1",
>              # "NCEP-CFSv2")
> 
> # variaveis <- c("prec", "tmax", "tmin", "t2mmax",
> #                "t2mmin", "tsmn", "tsmx", "tref")
> 
> baixados_prec_CanCM4i <- lapply(start_y : end_y,
+                                 function(iano) down_nmme(ano = iano)
+                                 )
Baixando arquivo: /home/andreza/Desktop/test-down-NMME/output/nmme_tmax_CanSIPSv2_1981.nc
trying URL 'http://iridl.ldeo.columbia.edu/SOURCES/.Models/.NMME/.CanSIPSv2/.HINDCAST/.MONTHLY/.tmax/S/%280000%201%20Jan%201981%29%280000%2030%20Dec%201981%29RANGEEDGES/X/%2830W%29%2885W%29RANGEEDGES/Y/%2860S%29%2815N%29RANGEEDGES/data.nc'
Error in download.file(data_link_ano, destfile = dest_file, mode = "wb") : 
  cannot open URL 'http://iridl.ldeo.columbia.edu/SOURCES/.Models/.NMME/.CanSIPSv2/.HINDCAST/.MONTHLY/.tmax/S/%280000%201%20Jan%201981%29%280000%2030%20Dec%201981%29RANGEEDGES/X/%2830W%29%2885W%29RANGEEDGES/Y/%2860S%29%2815N%29RANGEEDGES/data.nc'
Calls: lapply -> FUN -> down_nmme -> download.file
In addition: Warning message:
In download.file(data_link_ano, destfile = dest_file, mode = "wb") :
  URL 'http://iridl.ldeo.columbia.edu/SOURCES/.Models/.NMME/.CanSIPSv2/.HINDCAST/.MONTHLY/.tmax/S/%280000%201%20Jan%201981%29%280000%2030%20Dec%201981%29RANGEEDGES/X/%2830W%29%2885W%29RANGEEDGES/Y/%2860S%29%2815N%29RANGEEDGES/data.nc': Timeout of 60 seconds was reached
Execution halted
